
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Mileage Tracker</title>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />
    <style>
      :root {
        --primary: #4361ee;
        --secondary: #3f37c9;
        --success: #4cc9f0;
        --danger: #f72585;
        --warning: #f8961e;
        --info: #4895ef;
        --light: #f8f9fa;
        --dark: #212529;
        --gradient-primary: linear-gradient(135deg, #4361ee, #3a0ca3);
        --gradient-success: linear-gradient(135deg, #4cc9f0, #4895ef);
        --gradient-danger: linear-gradient(135deg, #f72585, #b5179e);
        --gradient-warning: linear-gradient(135deg, #f8961e, #f3722c);
        --box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1);
        --transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
        --card-border-radius: 16px;
        --button-border-radius: 8px;
      }

      body {
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        background: linear-gradient(135deg, #f0f4f8, #e6f0fa);
        padding: 0;
        margin: 0;
        color: var(--dark);
        transition: var(--transition);
        min-height: 100vh;
      }
      
      .topnav {
        background: white;
        width: 100%;
        position: fixed;
        top: 0;
        left: 0;
        z-index: 100;
        box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        display: flex;
        align-items: center;
        padding: 0 20px;
        height: 60px;
        box-sizing: border-box;
        justify-content: space-between;
        animation: fadeIn 0.5s ease-out;
      }
      
      .settings-btn {
        background: none;
        border: none;
        color: var(--primary);
        font-size: 20px;
        cursor: pointer;
        padding: 8px;
        margin-left: 10px;
        transition: var(--transition);
      }
      
      .settings-btn:hover {
        transform: rotate(30deg);
      }
      
      @keyframes fadeIn {
        from { opacity: 0; transform: translateY(-10px); }
        to { opacity: 1; transform: translateY(0); }
      }
      
      .app-title {
        display: flex;
        align-items: center;
        color: var(--primary);
        font-size: 18px;
        font-weight: 600;
        white-space: nowrap;
      }
      
      .app-title i {
        margin-right: 10px;
      }
      
      .vehicle-dropdown {
        position: relative;
        display: inline-block;
      }
      
      .vehicle-menu-btn {
        background: var(--gradient-primary);
        color: white;
        border: none;
        border-radius: 6px;
        padding: 8px 15px;
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 8px;
        font-size: 16px;
        box-shadow: 0 4px 10px rgba(67, 97, 238, 0.3);
        transition: var(--transition);
      }
      
      .vehicle-menu-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 15px rgba(67, 97, 238, 0.4);
      }
      
      .vehicle-dropdown-content {
        display: none;
        position: absolute;
        background-color: white;
        min-width: 200px;
        box-shadow: 0 8px 16px rgba(0,0,0,0.2);
        border-radius: 4px;
        z-index: 101;
        padding: 10px 15px 10px 10px;
        max-height: 300px;
        overflow-y: auto;
        overflow-x: hidden;
        left: 50%;
        transform: translateX(-50%);
        width: 230px;
        box-sizing: border-box;
      }
      
      .vehicle-dropdown-content.show {
        display: block;
      }
      
      .main-content {
        flex: 1;
        padding: 20px;
        overflow-y: auto;
        height: 100vh;
        margin-top: 60px;
        padding-bottom: 50px; /* Add space for footer */
      }
      
      .footer {
        position: fixed;
        bottom: 0;
        left: 0;
        width: 100%;
        background: rgba(255, 255, 255, 0.9);
        padding: 8px 0;
        text-align: center;
        font-size: 12px;
        color: #666;
        border-top: 1px solid #eee;
        backdrop-filter: blur(5px);
      }
      h1 {
        text-align: center;
        color: var(--secondary);
        margin-top: 10px;
        font-weight: 600;
        font-size: 1.5em;
      }
      .form-container,
      .popup {
        max-width: 500px;
        margin: auto;
        padding: 20px;
        background: white;
        border-radius: 12px;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
      }
      label {
        display: block;
        margin-top: 12px;
        font-weight: bold;
      }
      input {
        width: 100%;
        padding: 12px 15px;
        margin-top: 6px;
        border: 1px solid #e0e0e0;
        border-radius: 8px;
        font-size: 16px;
        box-sizing: border-box;
        transition: var(--transition);
        box-shadow: 0 2px 5px rgba(0,0,0,0.05) inset;
      }
      
      input:focus {
        border-color: var(--primary);
        box-shadow: 0 0 0 3px rgba(67, 97, 238, 0.15);
        outline: none;
      }
      input[readonly] {
        background-color: #e0f0ff;
      }
      table {
        width: 100%;
        margin-top: 30px;
        border-collapse: separate;
        border-spacing: 0;
        background: white;
        border-radius: var(--card-border-radius);
        overflow: hidden;
        box-shadow: var(--box-shadow);
        animation: fadeIn 0.8s ease-out;
        border: 1px solid rgba(230, 230, 250, 0.5);
      }
      th,
      td {
        padding: 16px 14px;
        border: none;
        border-bottom: 1px solid #eee;
      }
      th {
        background: var(--gradient-primary);
        color: white;
        text-align: center;
        font-weight: 600;
        letter-spacing: 0.5px;
      }
      
      tr {
        transition: var(--transition);
      }
      
      tr:hover:not(.highlight) {
        background-color: #f9fafc;
      }
      td.number {
        text-align: right;
        font-family: "Courier New", monospace;
      }
      td.text {
        text-align: left;
      }
      td.center {
        text-align: center;
      }

      @media (max-width: 768px) {
        body {
          padding: 10px;
        }
        .footer {
          font-size: 10px;
          padding: 6px 0;
        }
        h1 {
          font-size: 20px;
          margin-top: 20px;
        }
        table {
          display: block;
          overflow-x: auto;
          white-space: nowrap;
          font-size: 14px;
        }
        th,
        td {
          padding: 8px 6px;
        }
        .summary-card {
          padding: 15px 10px;
          display: grid;
          grid-template-columns: repeat(2, 1fr);
          grid-gap: 10px;
        }
        .summary-item {
          padding: 10px 5px;
          width: 100%;
          display: block;
        }
        .summary-value {
          font-size: 20px;
        }
        .summary-label {
          font-size: 12px;
        }
        .fab-button {
          width: 48px;
          height: 48px;
        }
        #addEntryBtn {
          bottom: 20px;
          right: 20px;
        }
        #clearDataBtn {
          bottom: 20px;
          left: 20px;
        }
        .popup,
        .add-popup {
          width: 90%;
          padding: 15px;
        }
        input {
          font-size: 16px; /* Prevents zoom on iOS */
        }
        .form-group i {
          top: 38px;
        }
        .topnav {
          padding: 0 10px;
          height: 50px;
        }
        .vehicle-menu-btn {
          font-size: 14px;
          padding: 6px 12px;
        }
        .vehicle-item {
          padding: 6px 8px;
          font-size: 13px;
        }
        .vehicle-actions {
          gap: 0;
        }
        .main-content {
          margin-top: 50px;
        }
        .vehicle-dropdown-content {
          min-width: 180px;
          max-width: 80vw;
          width: 200px;
          padding-right: 15px;
        }
        .app-title i {
          margin-right: 8px;
          font-size: 18px;
        }
        .app-title {
          font-size: 16px;
        }
        .header-container {
          margin-top: 10px;
        }
      }
      .action-button {
        background: var(--gradient-primary);
        color: white;
        border: none;
        cursor: pointer;
        padding: 8px;
        border-radius: 50%;
        width: 36px;
        height: 36px;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        transition: var(--transition);
        box-shadow: 0 3px 8px rgba(67, 97, 238, 0.3);
      }

      .action-button:hover {
        transform: scale(1.15) rotate(5deg);
        box-shadow: 0 5px 12px rgba(67, 97, 238, 0.4);
      }

      .popup,
      .add-popup {
        display: none;
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%) scale(0.95);
        background-color: white;
        z-index: 1000;
        padding: 25px;
        box-sizing: border-box;
        border-radius: var(--card-border-radius);
        box-shadow: 0 15px 35px rgba(0, 0, 0, 0.25);
        width: 340px;
        max-width: 90%;
        opacity: 0;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        border: 1px solid rgba(230, 230, 250, 0.5);
        background: linear-gradient(to bottom, #ffffff, #f8f9ff);
      }
      
      .popup.show,
      .add-popup.show {
        opacity: 1;
        transform: translate(-50%, -50%) scale(1);
      }

      .popup form,
      .add-popup form {
        width: 100%;
        box-sizing: border-box;
      }
      .popup-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100vw;
        height: 100vh;
        background-color: rgba(0, 0, 0, 0.5);
        display: none;
        z-index: 999;
        backdrop-filter: blur(3px);
        transition: opacity 0.3s ease;
        opacity: 0;
      }
      
      .popup-overlay.show {
        opacity: 1;
      }
      .form-actions {
        display: flex;
        justify-content: space-between;
        gap: 10px;
        margin-top: 20px;
      }
      button {
        border: none;
        border-radius: 6px;
        font-size: 16px;
        cursor: pointer;
        padding: 10px;
        flex: 1;
        color: white;
        transition: background-color 0.3s ease;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
      }
      .fab-button {
        position: fixed;
        width: 56px;
        height: 56px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        z-index: 1100;
        color: white;
        font-size: 24px;
        transition: all 0.3s ease;
      }

      .fab-button:hover {
        transform: scale(1.1);
      }

      #addEntryBtn {
        bottom: 30px;
        right: 30px;
        background: var(--gradient-success);
        position: fixed;
        z-index: 1100;
        box-shadow: 0 6px 16px rgba(76, 201, 240, 0.4);
        transition: var(--transition);
      }
      
      #addEntryBtn:hover {
        transform: scale(1.15) rotate(90deg);
      }

      .close-btn {
        position: absolute;
        top: 10px;
        right: 10px;
        background: none;
        border: none;
        font-size: 20px;
        cursor: pointer;
        color: #666;
      }
      .add-popup button[type="submit"] {
        background: var(--gradient-success);
        box-shadow: 0 4px 10px rgba(76, 201, 240, 0.3);
      }
      .add-popup button[type="button"] {
        background: var(--gradient-danger);
        box-shadow: 0 4px 10px rgba(247, 37, 133, 0.3);
      }
      .popup button[type="submit"] {
        background: var(--gradient-success);
        box-shadow: 0 4px 10px rgba(76, 201, 240, 0.3);
      }
      .popup button[type="button"] {
        background: var(--gradient-danger);
        box-shadow: 0 4px 10px rgba(247, 37, 133, 0.3);
      }
      
      .popup button:hover, .add-popup button:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 15px rgba(0, 0, 0, 0.2);
      }
      .summary-card {
        background: white;
        border-radius: 16px;
        padding: 25px 20px;
        margin-top: 15px;
        box-shadow: var(--box-shadow);
        display: flex;
        justify-content: center;
        align-items: center;
        flex-wrap: wrap;
        transition: var(--transition);
        animation: slideUp 0.6s ease-out;
        border: 1px solid rgba(230, 230, 250, 0.5);
      }
      
      @keyframes slideUp {
        from { opacity: 0; transform: translateY(20px); }
        to { opacity: 1; transform: translateY(0); }
      }
      
      .summary-card:hover {
        box-shadow: 0 15px 30px rgba(0, 0, 0, 0.12);
        transform: translateY(-3px);
      }
      .summary-item {
        text-align: center;
        padding: 10px 20px;
        min-width: 120px;
        position: relative;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
      }

      .summary-item:not(:last-child):after {
        content: "";
        position: absolute;
        right: 0;
        top: 20%;
        height: 60%;
        width: 1px;
        background-color: #e0e0e0;
      }

      .summary-icon {
        font-size: 28px;
        color: var(--primary);
        margin-bottom: 12px;
        margin-left: auto;
        margin-right: auto;
        background: linear-gradient(135deg, rgba(67, 97, 238, 0.15), rgba(67, 97, 238, 0.05));
        height: 60px;
        width: 60px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: var(--transition);
        box-shadow: 0 4px 8px rgba(67, 97, 238, 0.15);
      }
      
      .summary-item:hover .summary-icon {
        transform: scale(1.1) rotate(5deg);
        background: rgba(67, 97, 238, 0.15);
      }

      .summary-value {
        font-size: 28px;
        font-weight: bold;
        background: var(--gradient-primary);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        margin: 10px 0;
        width: 100%;
        text-align: center;
        transition: var(--transition);
        text-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        letter-spacing: 0.5px;
      }
      .summary-label {
        font-size: 14px;
        color: #666;
        width: 100%;
        text-align: center;
      }
      tr.highlight {
        background-color: rgba(76, 201, 240, 0.1);
        position: relative;
      }
      
      tr.highlight::after {
        content: '';
        position: absolute;
        left: 0;
        top: 0;
        height: 100%;
        width: 4px;
        background: var(--gradient-success);
      }
      .container {
        max-width: 1200px;
        margin: 0 auto;
        padding: 0 20px;
        width: 100%;
        box-sizing: border-box;
      }
      

      
      .header-container {
        text-align: center;
      }
      
      #vehicleNameHeader {
        color: var(--secondary);
        font-weight: 500;
      }
      
      .topnav h2 {
        color: var(--primary);
        font-size: 20px;
        margin: 0;
        margin-right: 20px;
      }
      
      #vehicleList {
        display: flex;
        flex-direction: column;
        width: 100%;
        margin-bottom: 10px;
      }
      
      .vehicle-item {
        padding: 10px 8px 10px 12px;
        transition: var(--transition);
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 6px;
        border-radius: 6px;
        font-size: 14px;
        width: 100%;
        box-sizing: border-box;
        border-left: 3px solid transparent;
      }
      
      .vehicle-item:hover {
        background: #f0f4f8;
        transform: translateX(3px);
      }
      
      .vehicle-item.active {
        background: var(--gradient-primary);
        color: white;
        box-shadow: 0 4px 10px rgba(67, 97, 238, 0.3);
      }
      
      .vehicle-name {
        cursor: pointer;
      }
      
      .vehicle-actions {
        display: flex;
        gap: 0;
        padding-right: 5px;
      }
      
      .vehicle-action {
        background: none;
        border: none;
        cursor: pointer;
        padding: 6px 3px;
        font-size: 12px;
        color: #666;
        border-radius: 3px;
        display: flex;
        align-items: center;
        justify-content: center;
        min-width: 24px;
      }
      
      .vehicle-item.active .vehicle-action {
        color: white;
      }
      
      .vehicle-action:hover {
        background: rgba(0, 0, 0, 0.1);
      }
      
      .clear-data {
        color: var(--warning) !important;
      }
      
      .delete-vehicle {
        color: var(--danger) !important;
      }
      
      #addVehicleBtn {
        background: var(--gradient-success);
        display: flex;
        align-items: center;
        justify-content: center;
        width: 100%;
        height: 40px;
        border-radius: 8px;
        padding: 8px;
        font-size: 14px;
        margin-top: 8px;
        box-shadow: 0 4px 10px rgba(76, 201, 240, 0.3);
        transition: var(--transition);
      }
      
      #addVehicleBtn:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 15px rgba(76, 201, 240, 0.4);
      }
      
      #addVehicleBtn span {
        display: inline;
      }

      .popup h2,
      .add-popup h2 {
        color: var(--primary);
        text-align: center;
        margin-top: 0;
      }

      .form-group {
        position: relative;
        margin-bottom: 20px;
      }

      .form-group i {
        position: absolute;
        left: 12px;
        top: 42px;
        color: #666;
      }

      .form-group input {
        padding-left: 40px;
      }
      
      .hint {
        font-size: 12px;
        color: #666;
        margin-top: 5px;
        font-style: italic;
      }
    </style>
  </head>
  <body>
    <div class="topnav" id="topnav">
      <div class="app-title">
        <i class="fas fa-gas-pump"></i>
        <span class="app-name">Mileage Tracker</span>
        <button class="settings-btn" onclick="openSettingsPopup()" title="Settings">
          <i class="fas fa-cog"></i>
        </button>
      </div>
      <div class="vehicle-dropdown">
        <button id="vehicleMenuBtn" class="vehicle-menu-btn">
          <i class="fas fa-car"></i> <span id="currentVehicleText">Select Vehicle</span> <i class="fas fa-chevron-down"></i>
        </button>
        <div id="vehicleDropdownContent" class="vehicle-dropdown-content">
          <div id="vehicleList"></div>
          <button id="addVehicleBtn" onclick="addNewVehicle()" title="Add Vehicle">
            <i class="fas fa-plus"></i><span> Add Vehicle</span>
          </button>
        </div>
      </div>
    </div>
    
    <div class="main-content">
      <div class="container">
      <button id="addEntryBtn" class="fab-button" onclick="openAddPopup()">
        <i class="fas fa-plus"></i>
      </button>



      <div class="summary-card" id="summaryCard">
        <div class="summary-item">
          <div class="summary-icon"><i class="fas fa-tachometer-alt"></i></div>
          <div class="summary-value" id="lastMileage">-</div>
          <div class="summary-label">Last Mileage (km/L)</div>
        </div>
        <div class="summary-item">
          <div class="summary-icon"><i class="fas fa-chart-line"></i></div>
          <div class="summary-value" id="avgMileage">-</div>
          <div class="summary-label">Avg Mileage (km/L)</div>
        </div>
        <div class="summary-item">
          <div class="summary-icon"><i class="fas fa-road"></i></div>
          <div class="summary-value" id="totalDistance">-</div>
          <div class="summary-label">Total Distance (km)</div>
        </div>
        <div class="summary-item">
          <div class="summary-icon"><i class="fas fa-oil-can"></i></div>
          <div class="summary-value" id="totalFuel">-</div>
          <div class="summary-label">Total Fuel (L)</div>
        </div>
      </div>
      


      <div class="popup-overlay" id="popupOverlay"></div>
      
      <div class="popup" id="settingsPopup">
        <button class="close-btn" onclick="closeSettingsPopup()">&times;</button>
        <h2><i class="fas fa-cog"></i> Settings</h2>
        <form id="settingsForm">
          <div class="form-group">
            <label>Default Fuel Price per Litre (Rs):</label>
            <i class="fas fa-rupee-sign"></i>
            <input type="number" step="0.01" id="settingsDefaultPrice" required />
          </div>
          <div class="form-actions">
            <button type="submit"><i class="fas fa-save"></i> Save</button>
            <button type="button" onclick="closeSettingsPopup()">
              <i class="fas fa-times"></i> Cancel
            </button>
          </div>
        </form>
      </div>
      
      <div class="popup" id="vehiclePopup">
        <button class="close-btn" onclick="closeVehiclePopup()">&times;</button>
        <h2><i class="fas fa-car"></i> Add Vehicle</h2>
        <form id="vehicleForm">
          <div class="form-group">
            <label>Vehicle Name:</label>
            <i class="fas fa-car"></i>
            <input type="text" id="vehicleName" required />
          </div>
          <div class="form-actions">
            <button type="submit"><i class="fas fa-save"></i> Save</button>
            <button type="button" onclick="closeVehiclePopup()">
              <i class="fas fa-times"></i> Cancel
            </button>
          </div>
        </form>
      </div>

      <div class="popup add-popup" id="addPopup">
        <button class="close-btn" onclick="closeAddPopup()">&times;</button>
        <h2><i class="fas fa-plus-circle"></i> New Entry</h2>
        <form id="mileageForm">
          <div class="form-group">
            <label>Fuel Price per Litre (Rs):</label>
            <i class="fas fa-rupee-sign"></i>
            <input type="number" step="0.01" id="price" required />
          </div>
          <div class="form-group">
            <label>Total Paid (Rs):</label>
            <i class="fas fa-money-bill-wave"></i>
            <input type="number" step="0.01" id="amount" required />
            <div class="hint" id="fuelHint"></div>
          </div>
          <div class="form-group">
            <label>Odometer Reading (km):</label>
            <i class="fas fa-tachometer-alt"></i>
            <input type="number" id="odometer" required />
            <div class="hint" id="odometerHint"></div>
          </div>
          <div class="form-actions">
            <button type="submit"><i class="fas fa-save"></i> Save</button>
            <button type="button" onclick="resetForm()">
              <i class="fas fa-undo"></i> Reset
            </button>
          </div>
        </form>
      </div>

      <div class="popup" id="editPopup">
        <button class="close-btn" onclick="closeEditPopup()">&times;</button>
        <h2><i class="fas fa-edit"></i> Edit Entry</h2>
        <form id="editForm">
          <div class="form-group">
            <label>Fuel Price per Litre (Rs):</label>
            <i class="fas fa-rupee-sign"></i>
            <input type="number" step="0.01" id="editPrice" required />
          </div>
          <div class="form-group">
            <label>Total Paid (Rs):</label>
            <i class="fas fa-money-bill-wave"></i>
            <input type="number" step="0.01" id="editAmount" required />
            <div class="hint" id="editFuelHint"></div>
          </div>
          <div class="form-group">
            <label>Odometer Reading (km):</label>
            <i class="fas fa-tachometer-alt"></i>
            <input type="number" id="editOdometer" required />
            <div class="hint" id="editOdometerHint"></div>
          </div>
          <div class="form-actions">
            <button type="submit"><i class="fas fa-save"></i> Update</button>
            <button type="button" onclick="closeEditPopup()">
              <i class="fas fa-times"></i> Cancel
            </button>
          </div>
        </form>
      </div>

      <div class="table-container">
        <table id="dataTable">
          <thead>
            <tr>
              <th><i class="far fa-calendar-alt"></i> Date</th>
              <th><i class="fas fa-route"></i> Distance (km)</th>
              <th><i class="fas fa-tachometer-alt"></i> Mileage (km/L)</th>
              <th><i class="fas fa-gas-pump"></i> Fuel (L)</th>
              <th><i class="fas fa-rupee-sign"></i> Price (Rs/L)</th>
              <th><i class="fas fa-money-bill-wave"></i> Total Paid (Rs)</th>
              <th><i class="fas fa-car"></i> Odometer</th>
              <th><i class="fas fa-calculator"></i> Trip Cost (Rs)</th>
              <th><i class="fas fa-cog"></i> Action</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
        <div style="margin-top: 15px; margin-bottom: 30px; text-align: left;">
          <button onclick="exportToPdf()" style="background: var(--gradient-primary); color: white; border: none; border-radius: 6px; padding: 8px 15px; cursor: pointer; box-shadow: 0 4px 10px rgba(67, 97, 238, 0.3); display: inline-flex; align-items: center; gap: 8px;">
            <i class="fas fa-file-pdf"></i> Export to PDF
          </button>
        </div>
      </div>
    </div>
    
    <div class="footer" style="display: flex; justify-content: center; align-items: center;">
      <span><i class="fas fa-info-circle"></i> Data is stored locally in your browser and is not shared across devices.</span>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
    <script>
      const form = document.getElementById("mileageForm");
      const editForm = document.getElementById("editForm");
      const tableBody = document.querySelector("#dataTable tbody");
      const editOdometer = document.getElementById("editOdometer");
      const editPrice = document.getElementById("editPrice");
      const editAmount = document.getElementById("editAmount");
      const popupOverlay = document.getElementById("popupOverlay");
      const editPopup = document.getElementById("editPopup");
      const addPopup = document.getElementById("addPopup");

      // Data structure for multiple vehicles
      let vehicles = JSON.parse(localStorage.getItem("vehicles")) || [];
      let currentVehicleId = localStorage.getItem("currentVehicleId") || null;
      
      // Default fuel price configuration
      let defaultFuelPrice = localStorage.getItem("defaultFuelPrice") || null;
      
      // Migrate old data if needed
      const oldData = JSON.parse(localStorage.getItem("mileageData"));
      let allData = JSON.parse(localStorage.getItem("allMileageData")) || {};
      
      if (oldData && !allData.default) {
        allData.default = oldData;
      }
      
      // Initialize data structure if needed
      let data = [];
      if (currentVehicleId && !allData[currentVehicleId]) {
        allData[currentVehicleId] = [];
      }
      
      if (currentVehicleId) {
        data = allData[currentVehicleId];
      }

      function formatDate(date) {
        return date
          .toLocaleString("en-GB", {
            day: "2-digit",
            month: "short",
            year: "numeric",
            hour: "2-digit",
            minute: "2-digit",
            hour12: true,
          })
          .replace(",", "");
      }

      function formatNumber(value, decimals = 2) {
        if (value === null || value === undefined || value === "-") return "-";
        return parseFloat(value).toFixed(decimals);
      }

      function updateSummary() {
        if (data.length === 0) {
          // Reset summary values when there's no data
          document.getElementById("lastMileage").textContent = "-";
          document.getElementById("avgMileage").textContent = "-";
          document.getElementById("totalDistance").textContent = "-";
          document.getElementById("totalFuel").textContent = "-";
          return;
        }

        const lastEntry = data[data.length - 1];
        document.getElementById("lastMileage").textContent =
          lastEntry.mileage || "-";

        let totalDistance = 0;
        let totalFuel = 0;
        let validEntries = 0;

        data.forEach((entry) => {
          if (entry.distance) totalDistance += parseFloat(entry.distance);
          if (entry.fuel) totalFuel += parseFloat(entry.fuel);
          if (entry.mileage) validEntries++;
        });

        const avgMileage =
          validEntries > 0 ? (totalDistance / totalFuel).toFixed(2) : "-";

        document.getElementById("avgMileage").textContent = avgMileage;
        document.getElementById("totalDistance").textContent = formatNumber(
          totalDistance,
          0
        );
        document.getElementById("totalFuel").textContent = formatNumber(
          totalFuel,
          2
        );
      }

      function confirmClearData() {
        if (
          confirm(
            "Are you sure you want to clear data for this vehicle? This action cannot be undone."
          )
        ) {
          allData[currentVehicleId] = [];
          data = [];
          localStorage.setItem("allMileageData", JSON.stringify(allData));
          updateTable();
          alert("Vehicle data has been cleared.");
        }
      }

      function updateTable() {
        tableBody.innerHTML = "";

        if (!currentVehicleId) {
          const emptyRow = document.createElement("tr");
          emptyRow.innerHTML = `<td colspan="9" style="text-align: center; padding: 20px;">No vehicle selected. Add a vehicle first.</td>`;
          tableBody.appendChild(emptyRow);
          return;
        }
        
        if (data.length === 0) {
          const emptyRow = document.createElement("tr");
          emptyRow.innerHTML = `<td colspan="9" style="text-align: center; padding: 20px;">No entries yet. Click the + button to add your first entry <b style="color:red">after a FULL TANK refill</b> to get accurate mileage calculations.</td>`;
          tableBody.appendChild(emptyRow);
          return;
        }

        // Add custom styles for the table
        const style = document.createElement("style");
        style.textContent = `
          td.number { 
            font-family: 'Segoe UI', Roboto, Arial, sans-serif; 
            font-weight: 500;
          }
          td.text { 
            font-family: 'Segoe UI', Roboto, Arial, sans-serif;
          }
          #dataTable tbody tr {
            animation: fadeIn 0.5s ease-out;
            animation-fill-mode: both;
          }
          #dataTable tbody tr:nth-child(1) { animation-delay: 0.1s; }
          #dataTable tbody tr:nth-child(2) { animation-delay: 0.2s; }
          #dataTable tbody tr:nth-child(3) { animation-delay: 0.3s; }
          #dataTable tbody tr:nth-child(4) { animation-delay: 0.4s; }
          #dataTable tbody tr:nth-child(5) { animation-delay: 0.5s; }
        `;
        document.head.appendChild(style);

        // Show newest entries on top by reversing data
        [...data].reverse().forEach((entry, index) => {
          const realIndex = data.length - 1 - index;
          const row = document.createElement("tr");
          if (index === 0) row.classList.add("highlight");

          row.innerHTML = `
          <td class="text">${entry.date}</td>
          <td class="number">${entry.distance || "-"}</td>
          <td class="number">${entry.mileage || "-"}</td>
          <td class="number">${entry.fuel}</td>
          <td class="number">${entry.price}</td>
          <td class="number">${entry.amount}</td>
          <td class="number">${entry.odometer}</td>
          <td class="number">${entry.tripCost || "-"}</td>
          <td class="center">${
            realIndex === data.length - 1
              ? '<button class="action-button" onclick="editLastEntry()"><i class="fas fa-edit"></i></button>'
              : ""
          }</td>
        `;
          tableBody.appendChild(row);
        });

        updateSummary();
      }

      function resetForm() {
        form.reset();
      }

      function openAddPopup() {
        if (!currentVehicleId) {
          addNewVehicle();
          return;
        }
        
        // Show full tank reminder for first entry
        if (data.length === 0) {
          alert("IMPORTANT: Please make sure you're entering data after a FULL TANK refill for your first entry to get accurate mileage calculations.");
        }
        
        // Show previous odometer value and auto-populate first 2 digits
        const odometerField = document.getElementById("odometer");
        const odometerHint = document.getElementById("odometerHint");
        odometerField.value = ""; // Clear the field first
        
        // Set default fuel price from configuration
        const priceField = document.getElementById("price");
        priceField.value = defaultFuelPrice;
        
        // Clear amount field and set default fuel hint
        document.getElementById("amount").value = "";
        document.getElementById("fuelHint").textContent = "Refilled fuel: 0.00 L";

        if (data.length > 0) {
          const lastEntry = data[data.length - 1];
          odometerHint.textContent = `Previous reading: ${lastEntry.odometer}`;

          // Auto-populate odometer prefix based on value
          const lastOdo = lastEntry.odometer;
          const lastOdoStr = lastOdo.toString();
          if (lastOdo < 1000) {
            odometerField.value = lastOdoStr.substring(0, 1);
          } else if (lastOdo < 100000) {
            odometerField.value = lastOdoStr.substring(0, 2);
          } else {
            odometerField.value = lastOdoStr.substring(0, 3);
          }
        } else {
          odometerHint.textContent = "";
        }
        
        // Add event listeners for real-time calculation
        setupFuelCalculation("price", "amount", "fuelHint");

        showOverlay();
        addPopup.style.display = "block";
        
        // Add animation
        setTimeout(() => {
          addPopup.classList.add("show");
        }, 10);
      }
      
      function closeAddPopup() {
        addPopup.classList.remove("show");
        hideOverlay();
        setTimeout(() => {
          addPopup.style.display = "none";
        }, 300);
      }

      function calculateTripCost(distance, mileage, price) {
        if (mileage && price > 0) {
          return parseInt(Math.round((distance / mileage) * price));
        }
        return null;
      }

      form.addEventListener("submit", function (e) {
        e.preventDefault();
        const odometer = parseFloat(document.getElementById("odometer").value);
        const price = parseFloat(document.getElementById("price").value);
        const amount = parseFloat(document.getElementById("amount").value);
        const fuel = amount / price;

        // If defaultFuelPrice is not set, save the current price as default
        if (!defaultFuelPrice) {
          defaultFuelPrice = price;
          localStorage.setItem("defaultFuelPrice", defaultFuelPrice);
        }

        const lastEntry = data[data.length - 1];
        if (lastEntry && odometer <= lastEntry.odometer) {
          alert("Odometer reading must be greater than the previous entry.");
          return;
        }

        const distance = lastEntry ? odometer - lastEntry.odometer : null;
        const mileage =
          distance && fuel > 0 ? (distance / fuel).toFixed(2) : null;
        const tripCost = calculateTripCost(distance, mileage, price);

        const entry = {
          date: formatDate(new Date()),
          odometer,
          fuel: fuel.toFixed(2),
          price,
          amount: amount.toFixed(2),
          distance: distance || null,
          mileage: mileage || null,
          tripCost: tripCost || null,
        };

        data.push(entry);
        allData[currentVehicleId] = data;
        localStorage.setItem("allMileageData", JSON.stringify(allData));
        updateTable();
        resetForm();
        closeAddPopup();
      });

      function editLastEntry() {
        const last = data[data.length - 1];
        editOdometer.value = last.odometer;
        editPrice.value = last.price || defaultFuelPrice;
        editAmount.value = last.amount;
        
        // Set hints
        const previousEntry = data.length > 1 ? data[data.length - 2] : null;
        document.getElementById("editOdometerHint").textContent = previousEntry ? 
          `Previous reading: ${previousEntry.odometer}` : "";
        document.getElementById("editFuelHint").textContent = 
          `Refilled fuel: ${(last.amount / last.price).toFixed(2)} L`;
        
        showOverlay();
        editPopup.style.display = "block";
        
        // Add animation
        setTimeout(() => {
          editPopup.classList.add("show");
        }, 10);
        
        // Add event listeners for real-time calculation
        setupFuelCalculation("editPrice", "editAmount", "editFuelHint");
      }

      function closeEditPopup() {
        editPopup.classList.remove("show");
        hideOverlay();
        setTimeout(() => {
          editPopup.style.display = "none";
        }, 300);
      }

      editForm.addEventListener("submit", function (e) {
        e.preventDefault();
        const odometer = parseFloat(editOdometer.value);
        const price = parseFloat(editPrice.value);
        const amount = parseFloat(editAmount.value);
        const fuel = amount / price;

        const previousEntry = data.length > 1 ? data[data.length - 2] : null;
        if (previousEntry && odometer <= previousEntry.odometer) {
          alert("Odometer reading must be greater than the previous entry.");
          return;
        }

        const distance = previousEntry
          ? odometer - previousEntry.odometer
          : null;
        const mileage =
          distance && fuel > 0 ? (distance / fuel).toFixed(2) : null;
        const tripCost = calculateTripCost(distance, mileage, price);

        data[data.length - 1] = {
          date: formatDate(new Date()),
          odometer,
          fuel: fuel.toFixed(2),
          price,
          amount: amount.toFixed(2),
          distance: distance || null,
          mileage: mileage || null,
          tripCost: tripCost || null,
        };

        allData[currentVehicleId] = data;
        localStorage.setItem("allMileageData", JSON.stringify(allData));
        closeEditPopup();
        updateTable();
      });

      popupOverlay.addEventListener("click", () => {
        closeAddPopup();
        closeEditPopup();
        closeVehiclePopup();
        closeSettingsPopup();
      });
      
      // Function to show overlay with animation
      function showOverlay() {
        popupOverlay.style.display = "block";
        setTimeout(() => {
          popupOverlay.classList.add("show");
        }, 10);
      }
      
      // Function to hide overlay with animation
      function hideOverlay() {
        popupOverlay.classList.remove("show");
        setTimeout(() => {
          popupOverlay.style.display = "none";
        }, 300);
      }

      // Vehicle management functions
      function renderVehicleList() {
        const vehicleList = document.getElementById("vehicleList");
        vehicleList.innerHTML = "";
        
        vehicles.forEach(vehicle => {
          const item = document.createElement("div");
          item.className = "vehicle-item" + (vehicle.id === currentVehicleId ? " active" : "");
          
          item.innerHTML = `
            <span class="vehicle-name">${vehicle.name}</span>
            <div class="vehicle-actions">
              <button class="vehicle-action clear-data" title="Clear Data" data-id="${vehicle.id}">
                <i class="fas fa-eraser"></i>
              </button>
              <button class="vehicle-action delete-vehicle" title="Delete Vehicle" data-id="${vehicle.id}">
                <i class="fas fa-trash"></i>
              </button>
            </div>
          `;
          
          item.querySelector(".vehicle-name").addEventListener("click", () => {
            switchVehicle(vehicle.id);
            toggleVehicleDropdown();
          });
          
          item.querySelector(".clear-data").addEventListener("click", (e) => {
            e.stopPropagation();
            clearVehicleData(vehicle.id);
          });
          
          item.querySelector(".delete-vehicle").addEventListener("click", (e) => {
            e.stopPropagation();
            deleteVehicle(vehicle.id);
          });
          
          vehicleList.appendChild(item);
        });
        
        // Update vehicle name display
        updateVehicleNameDisplay();
      }
      
      function switchVehicle(vehicleId) {
        currentVehicleId = vehicleId;
        localStorage.setItem("currentVehicleId", vehicleId);
        
        if (!allData[vehicleId]) {
          allData[vehicleId] = [];
        }
        
        data = allData[vehicleId];
        updateTable();
        updateSummary(); // Explicitly update summary when switching vehicles
        renderVehicleList();
        updateVehicleNameDisplay();
      }
      
      function updateVehicleNameDisplay() {
        const currentVehicleText = document.getElementById("currentVehicleText");
        const currentVehicle = vehicles.find(v => v.id === currentVehicleId);
        
        let displayName = "Select Vehicle";
        
        if (currentVehicle) {
          displayName = currentVehicle.name;
        }
        
        currentVehicleText.textContent = displayName;
        
        // If no vehicle is selected, disable the add entry button
        const addEntryBtn = document.getElementById("addEntryBtn");
        if (!currentVehicleId) {
          addEntryBtn.style.opacity = "0.5";
          addEntryBtn.title = "Please add a vehicle first";
        } else {
          addEntryBtn.style.opacity = "1";
          addEntryBtn.title = "Add new entry";
        }
      }
      
      function addNewVehicle() {
        const vehiclePopup = document.getElementById("vehiclePopup");
        vehiclePopup.style.display = "block";
        showOverlay();
        
        // Add animation
        setTimeout(() => {
          vehiclePopup.classList.add("show");
        }, 10);
      }
      
      function closeVehiclePopup() {
        const vehiclePopup = document.getElementById("vehiclePopup");
        vehiclePopup.classList.remove("show");
        hideOverlay();
        setTimeout(() => {
          vehiclePopup.style.display = "none";
          document.getElementById("vehicleForm").reset();
        }, 300);
      }
      
      function deleteVehicle(vehicleId) {
        if (confirm("Are you sure you want to delete this vehicle and all its data?")) {
          vehicles = vehicles.filter(v => v.id !== vehicleId);
          delete allData[vehicleId];
          
          localStorage.setItem("vehicles", JSON.stringify(vehicles));
          localStorage.setItem("allMileageData", JSON.stringify(allData));
          
          if (currentVehicleId === vehicleId) {
            if (vehicles.length > 0) {
              switchVehicle(vehicles[0].id);
            } else {
              // No vehicles left, create empty state
              currentVehicleId = null;
              data = [];
              updateTable();
              updateSummary(); // Explicitly update summary when deleting the current vehicle
              updateVehicleNameDisplay();
              renderVehicleList();
            }
          } else {
            renderVehicleList();
          }
        }
      }
      
      function clearVehicleData(vehicleId) {
        const vehicle = vehicles.find(v => v.id === vehicleId);
        if (confirm(`Are you sure you want to clear all data for "${vehicle.name}"? This action cannot be undone.`)) {
          allData[vehicleId] = [];
          
          if (vehicleId === currentVehicleId) {
            data = [];
            updateTable();
            updateSummary(); // Explicitly update summary when clearing data
          }
          
          localStorage.setItem("allMileageData", JSON.stringify(allData));
          alert(`Data for "${vehicle.name}" has been cleared.`);
        }
      }
      
      document.getElementById("vehicleForm").addEventListener("submit", function(e) {
        e.preventDefault();
        const vehicleName = document.getElementById("vehicleName").value.trim();
        
        if (!vehicleName) {
          alert("Please enter a vehicle name");
          return;
        }
        
        // Check for duplicate vehicle name
        const duplicateVehicle = vehicles.find(v => v.name.toLowerCase() === vehicleName.toLowerCase());
        if (duplicateVehicle) {
          alert("A vehicle with this name already exists. Please use a different name.");
          return;
        }
        
        const vehicleId = "v_" + Date.now();
        vehicles.push({ id: vehicleId, name: vehicleName });
        
        localStorage.setItem("vehicles", JSON.stringify(vehicles));
        closeVehiclePopup();
        switchVehicle(vehicleId);
      });
      
      // Toggle vehicle dropdown
      function toggleVehicleDropdown() {
        const dropdown = document.getElementById("vehicleDropdownContent");
        dropdown.classList.toggle("show");
      }
      
      // Close dropdown when clicking outside
      window.addEventListener("click", function(event) {
        if (!event.target.matches(".vehicle-menu-btn") && 
            !event.target.closest(".vehicle-menu-btn") && 
            !event.target.closest(".vehicle-dropdown-content")) {
          const dropdown = document.getElementById("vehicleDropdownContent");
          if (dropdown.classList.contains("show")) {
            dropdown.classList.remove("show");
          }
        }
      });
      
      // Add click event to dropdown button
      document.getElementById("vehicleMenuBtn").addEventListener("click", function(e) {
        e.stopPropagation();
        toggleVehicleDropdown();
        
        // If no vehicles exist, automatically open the add vehicle popup
        if (vehicles.length === 0) {
          addNewVehicle();
        }
      });
      
      // Settings popup functions
      function openSettingsPopup(callback) {
        const settingsPopup = document.getElementById("settingsPopup");
        document.getElementById("settingsDefaultPrice").value = defaultFuelPrice;
        settingsPopup.style.display = "block";
        showOverlay();
        
        // Store callback to be called after settings are saved
        settingsPopup.callback = callback;
        
        setTimeout(() => {
          settingsPopup.classList.add("show");
        }, 10);
      }
      
      function closeSettingsPopup() {
        const settingsPopup = document.getElementById("settingsPopup");
        settingsPopup.classList.remove("show");
        hideOverlay();
        setTimeout(() => {
          settingsPopup.style.display = "none";
        }, 300);
      }
      
      document.getElementById("settingsForm").addEventListener("submit", function(e) {
        e.preventDefault();
        const newDefaultPrice = document.getElementById("settingsDefaultPrice").value;
        
        // Update default fuel price
        defaultFuelPrice = newDefaultPrice;
        localStorage.setItem("defaultFuelPrice", defaultFuelPrice);
  
        // Execute callback if exists
        const callback = document.getElementById("settingsPopup").callback;
        // Clear the callback to prevent it from being called again
        document.getElementById("settingsPopup").callback = null;
        
        closeSettingsPopup();
        
        // Run the callback after closing
        if (typeof callback === 'function') {
          setTimeout(callback, 500);
        }
      });
      
      // Function to calculate and display fuel amount based on price and total paid
      function setupFuelCalculation(priceId, amountId, hintId) {
        const priceField = document.getElementById(priceId);
        const amountField = document.getElementById(amountId);
        const hintElement = document.getElementById(hintId);
        
        // Function to calculate fuel
        function calculateFuel() {
          const price = parseFloat(priceField.value);
          const amount = parseFloat(amountField.value);
          
          if (price && amount && price > 0) {
            const fuel = amount / price;
            hintElement.textContent = `Refilled fuel: ${fuel.toFixed(2)} L`;
          } else {
            hintElement.textContent = "Refilled fuel: 0.00 L";
          }
        }
        
        // Add event listeners
        priceField.addEventListener("input", calculateFuel);
        amountField.addEventListener("input", calculateFuel);
      }
      
      // Function to export data to PDF
      function exportToPdf() {
        if (!currentVehicleId || data.length === 0) {
          alert("No data to export. Please add entries first.");
          return;
        }
        
        // Get vehicle name
        const vehicle = vehicles.find(v => v.id === currentVehicleId);
        const vehicleName = vehicle ? vehicle.name : "Vehicle";
        
        // Ask for confirmation before generating PDF
        if (!confirm(`Generate PDF report for ${vehicleName}?`)) {
          return;
        }
        
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();
        
        // Add title
        doc.setFontSize(18);
        doc.text(`Mileage Report - ${vehicleName}`, 14, 22);
        
        // Add summary
        doc.setFontSize(12);
        doc.text(`Average Mileage: ${document.getElementById("avgMileage").textContent} km/L`, 14, 32);
        doc.text(`Total Distance: ${document.getElementById("totalDistance").textContent} km`, 14, 38);
        doc.text(`Total Fuel: ${document.getElementById("totalFuel").textContent} L`, 14, 44);
        doc.text(`Generated on: ${formatDate(new Date())}`, 14, 50);
        
        // Create table data
        const tableData = [];
        data.forEach(entry => {
          tableData.push([
            entry.date,
            entry.distance || "-",
            entry.mileage || "-",
            entry.fuel,
            entry.price,
            entry.amount,
            entry.odometer,
            entry.tripCost || "-"
          ]);
        });
        
        // Add table
        doc.autoTable({
          startY: 60,
          head: [['Date', 'Distance (km)', 'Mileage (km/L)', 'Fuel (L)', 'Price (Rs/L)', 'Total Paid (Rs)', 'Odometer', 'Trip Cost (Rs)']],
          body: tableData,
          theme: 'striped',
          headStyles: { fillColor: [67, 97, 238] }
        });
        
        // Save PDF
        doc.save(`mileage-report-${vehicleName.replace(/\s+/g, '-').toLowerCase()}.pdf`);
      }
      
      renderVehicleList();
      updateVehicleNameDisplay();
      updateTable();
    </script>
  </body>
</html>
